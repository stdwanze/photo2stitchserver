<!DOCTYPE HTML>
<html>
	<head>
		<title>Factorio Sales Data</title>

		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
		 <style>
	      body {
	        font-family: 'Open Sans', sans-serif;
	      }
   		</style>
		<script type="text/javascript">
			var fake = false;
			var fakeData = JSON.parse("[{\"_date\":\"8_6_2014\",\"max\":35783,\"min\":35754,\"sold\":29,\"date\":\"2014-07-08T23:00:02.635Z\",\"avg\":3.2222222222222223,\"hourlymax\":9,\"hourlymin\":1},{\"_date\":\"9_6_2014\",\"max\":35874,\"min\":35785,\"sold\":89,\"date\":\"2014-07-09T23:00:03.158Z\",\"avg\":3.7083333333333335,\"hourlymax\":11,\"hourlymin\":1},{\"_date\":\"10_6_2014\",\"max\":35965,\"min\":35878,\"sold\":87,\"date\":\"2014-07-10T23:00:03.631Z\",\"avg\":3.625,\"hourlymax\":11,\"hourlymin\":1},{\"_date\":\"11_6_2014\",\"max\":36055,\"min\":35969,\"sold\":86,\"date\":\"2014-07-11T23:00:03.302Z\",\"avg\":3.5833333333333335,\"hourlymax\":8,\"hourlymin\":1},{\"_date\":\"12_6_2014\",\"max\":36142,\"min\":36056,\"sold\":86,\"date\":\"2014-07-12T23:00:03.705Z\",\"avg\":3.5833333333333335,\"hourlymax\":12,\"hourlymin\":1},{\"_date\":\"13_6_2014\",\"max\":36262,\"min\":36143,\"sold\":119,\"date\":\"2014-07-13T23:00:03.158Z\",\"avg\":4.958333333333333,\"hourlymax\":10,\"hourlymin\":2},{\"_date\":\"14_6_2014\",\"max\":36359,\"min\":36264,\"sold\":95,\"date\":\"2014-07-14T23:00:03.150Z\",\"avg\":3.9583333333333335,\"hourlymax\":15,\"hourlymin\":1},{\"_date\":\"15_6_2014\",\"max\":36436,\"min\":36362,\"sold\":74,\"date\":\"2014-07-15T23:00:02.753Z\",\"avg\":3.0833333333333335,\"hourlymax\":8,\"hourlymin\":1},{\"_date\":\"16_6_2014\",\"max\":36503,\"min\":36438,\"sold\":65,\"date\":\"2014-07-16T23:00:02.362Z\",\"avg\":2.7083333333333335,\"hourlymax\":11,\"hourlymin\":1},{\"_date\":\"17_6_2014\",\"max\":36580,\"min\":36506,\"sold\":74,\"date\":\"2014-07-17T23:00:03.078Z\",\"avg\":3.0833333333333335,\"hourlymax\":6,\"hourlymin\":1},{\"_date\":\"18_6_2014\",\"max\":36640,\"min\":36583,\"sold\":57,\"date\":\"2014-07-18T23:00:02.880Z\",\"avg\":2.375,\"hourlymax\":7,\"hourlymin\":1},{\"_date\":\"19_6_2014\",\"max\":36713,\"min\":36640,\"sold\":73,\"date\":\"2014-07-19T23:00:03.117Z\",\"avg\":3.0416666666666665,\"hourlymax\":7,\"hourlymin\":1},{\"_date\":\"20_6_2014\",\"max\":36789,\"min\":36716,\"sold\":73,\"date\":\"2014-07-20T23:00:03.184Z\",\"avg\":3.0416666666666665,\"hourlymax\":9,\"hourlymin\":1},{\"_date\":\"21_6_2014\",\"max\":36853,\"min\":36792,\"sold\":61,\"date\":\"2014-07-21T23:00:03.240Z\",\"avg\":2.5416666666666665,\"hourlymax\":7,\"hourlymin\":1},{\"_date\":\"22_6_2014\",\"max\":36880,\"min\":36856,\"sold\":24,\"date\":\"2014-07-22T13:00:03.273Z\",\"avg\":1.7142857142857142,\"hourlymax\":4,\"hourlymin\":1}]");
			if (fake) {
				$.ajax = function(config) {
					config.success(fakeData);
				};
			};

			google.load("visualization", "1", {
				packages : ["corechart"]
			});
			google.setOnLoadCallback(loadAndDraw);

			function getHistoryWindow(array, size,offset)
			{
				var ret = [];
				
				for (var i = 0; i < size; i++) {
				
					var currIndex = i+offset-size;
					if(currIndex < 0) ret.push(0);
					else if(currIndex >= array.length) ret.push(0);
					else
					{
						ret.push(array[currIndex]);
					} 
				}
				return ret;
				
			}
			function foldArray(array)
			{
				var ret = [];
				for (var i = 0; i < array.length; i++) {
					
					if(i > 0 && array[i-1] > 0)
					{
						ret.push(array[i]-array[i-1]);
					}
				}
				return ret;
			}
			function avg(array)
			{
				var ret = 0;
				for (var i = 0; i < array.length; i++) {
					
					ret += array[i];
				}
				return ret/array.length;
			}
			function makeArray(complex, accessor)
			{
				var ret = [];
				for (var i = 0; i < complex.length; i++) {
						ret.push(accessor(complex[i]));
				}
				return ret;
			}

			function buildTable(rawDataTable) {
				var composite = {
					overall : "",
					dayly : ""
				};
				composite.dayly = [["Date", "Sold that day","Max Per Hour","Min Per Hour","Avg per Hour","7-Day Projected"]];
				composite.overall = [["Date", "Sold","14-Day Projected"]];
				
				var soldbase = makeArray(rawDataTable,function (entry){ return parseInt(entry.max);});
				var solddailybase = makeArray(rawDataTable,function (entry){ return parseInt(entry.sold);});
				
					
				for (var i = 0; i < rawDataTable.length; i++) {
					var rawEntry = rawDataTable[i];
					var parsedDate = new Date(Date.parse(rawEntry.date));
					var formated = parsedDate.toUTCString();
					
					var projectedOverall = 0;
					var projectedDaily = 0;
					
					if(i > 0)
					{
						var avggrowth = avg(foldArray(getHistoryWindow(soldbase,14,i)));
						var avggrowthDaily = avg(foldArray(getHistoryWindow(solddailybase,7,i)));
						
						projectedOverall = !isNaN(avggrowth)? soldbase[i-1]+avggrowth : soldbase[i];
						projectedDaily = !isNaN(avggrowthDaily)? solddailybase[i-1]+avggrowthDaily : solddailybase[i];
					}
					else {
						projectedOverall = parseInt(rawEntry.max);
						projectedDaily = parseInt(rawEntry.sold);
					}
					var entryDayly = [formated, parseInt(rawEntry.sold),parseInt(rawEntry.hourlymax),parseInt(rawEntry.hourlymin),parseFloat(rawEntry.avg),projectedDaily];
					var entryOverall = [formated, parseInt(rawEntry.max),projectedOverall];
					
					composite.dayly.push(entryDayly);
					composite.overall.push(entryOverall);
				}
				return composite;
			}

			function loadAndDraw() {
				$.ajax({
					url : 'http://nodetwo.cloudapp.net/getFactorioSalesData',
					success : function(data) {
						var graphdata = buildTable(data);

						var optionsOverall = {
							title : "Overall Factorio Sales", //'Company Performance',
							hAxis : {
								title : 'Sales',
								titleTextStyle : {
									color : 'red'
								}
							}
						};
						var optionsDaly = {
							title : "Daily Factorio Sales", //'Company Performance',
							hAxis : {
								title : 'Sales',
								titleTextStyle : {
									color : 'red'
								}
							},
							seriesType: "bars",
         					series: {3: {type: "line"}, 4:{type: "line"}}
						};

						drawChart( graphdata.overall, optionsOverall, function(element) {
							return new google.visualization.LineChart(document.getElementById('chart_div'))
						});
						drawChart( graphdata.dayly, optionsDaly, function(element) {
							return new google.visualization.ColumnChart(document.getElementById('chart_div_perDay'))
						});
					},
					error : function(err, text) {
						$("#console").append(text);
					}
				});
			}

			function drawChart(input, options, chartFactory) {
				var data = google.visualization.arrayToDataTable(input);

				var chart = chartFactory();
				//new google.visualization.ColumnChart();
				chart.draw(data, options);
			}
		</script>
	</head>
	<body>
		<div><a href='http://factorio.com'>Factorio, the game's website</a></div>
		<div id="chart_div" style="width: 1000px; height: 450px;"></div>
		<div id="chart_div_perDay" style="width: 1000px; height: 450px;"></div>

		<div id="console"></div>
	</body>
</html>